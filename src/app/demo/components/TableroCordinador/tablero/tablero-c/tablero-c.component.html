<div class="grid">
	<div class="col-12">
		<div class="card">
			<h5>Grupos de Actividades</h5>
			<p-toast></p-toast>
			<button pButton label="Crear Nuevo Grupo" icon="pi pi-plus" (click)="displayModal = true"
				class="mb-3"></button>
			<p-table [value]="taskGroups" dataKey="id" rowGroupMode="subheader" [groupRowsBy]="['name']"
				responsiveLayout="scroll">
				<ng-template pTemplate="header">
					<tr>
						<th>Nombre del Grupo</th>
						<th>Fecha de Inicio</th>
						<th>Fecha de Fin</th>
						<th>Acciones</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-group let-rowIndex="rowIndex">
					<tr>
						<td>{{ group.name }}</td>
						<td>{{ group.startdate | date }}</td>
						<td>{{ group.enddate | date }}</td>
						<td>
							<div class="flex align-items-center">
								<button pButton (click)="expandedRows[group.name] = !expandedRows[group.name]; loadActivities(group.idgrouptaskcl)" 
										[label]="expandedRows[group.name] ? 'Ocultar Actividades' : 'Mostrar Actividades'" 
										icon="pi pi-chevron-down" class="mr-2"></button>
								<button pButton label="Modificar" icon="pi pi-pencil" (click)="editGroup(group.id)" class="mr-2"></button>
								<button pButton label="Eliminar" icon="pi pi-trash" (click)="deleteGroup(group.id)"></button>
							</div>
						</td>
					</tr>
					<tr *ngIf="expandedRows[group.name]">
						<td colspan="5">
							<div class="card">
								<h6>Actividades</h6>
								<p-table [value]="activities" dataKey="id" responsiveLayout="scroll">
									<ng-template pTemplate="header">
										<tr>
											<th>Nombre</th>
											<th>Descripción</th>
											<th>Fecha de Fin</th>
											<th>Importante</th>
											<th>Etiqueta</th>
											<th>Acciones</th>
										</tr>
									</ng-template>
									<ng-template pTemplate="body" let-activity>
										<tr>
											<td>{{ activity.nameT }}</td>
											<td>{{ activity.descriptionT }}</td>
											<td>{{ activity.end_date | date }}</td>
											<td>{{ activity.important === 1 ? 'Sí' : 'No' }}</td>
											<td>
												<span *ngFor="let label of labels" [hidden]="label.idLabel !== activity.idLabel">
													{{ label.nameL }}
												</span>
											</td>
											<td>
												<button pButton label="Modificar" icon="pi pi-pencil" (click)="editActivity(activity.idactivitycl)"></button>
												<button pButton label="Eliminar" icon="pi pi-trash" (click)="deleteActivity(activity.idactivitycl)"></button>
											</td>
										</tr>
									</ng-template>
								</p-table>
								<div class="card">
									<h6>Agregar Actividad</h6>
									<div class="formgrid grid">
										<div class="field col-12 md:col-4">
											<label for="activityName">Nombre de la Actividad:</label>
											<input id="activityName" [(ngModel)]="newActivity.nameT" pInputText
												placeholder="Nombre de la Actividad"
												class="w-full" />
										</div>
										<div class="field col-12 md:col-4">
											<label for="activityDescription">Descripción de la Actividad:</label>
											<input id="activityDescription" [(ngModel)]="newActivity.descriptionT"
												pInputText placeholder="Descripción de la Actividad"
												class="w-full" />
										</div>
										<div class="field col-12 md:col-4">
											<label for="activityEndDate">Fecha de Fin:</label>
											<input id="activityEndDate" [(ngModel)]="newActivity.end_date" type="date"
												pInputText
												class="w-full" />
										</div>
										<div class="field col-12 md:col-4">
											<label for="activityImportant">Importante (0 o 1):</label>
											<input id="activityImportant" [(ngModel)]="newActivity.important"
												type="number" pInputText placeholder="Importante (0 o 1)"
												class="w-full" />
										</div>
										<div class="field col-12 md:col-4">
											<label for="activityLabel">Etiqueta:</label>
											<select id="activityLabel" [(ngModel)]="newActivity.idLabel"
												class="w-full" pInputText>
												<option *ngFor="let label of labels" [value]="label.idLabel"
													[ngStyle]="{'background-color': label.colorL, 'color': '#fff'}">
													{{ label.nameL }}
												</option>
											</select>
										</div>
										<div class="field col-12 md:col-4">
											<label for="activityLabel">Nueva Etiqueta:</label>
											<button pButton label="Crear Etiqueta" icon="pi pi-plus" class="w-full"></button>
										</div>
									</div>
									<div class="flex justify-content-end">
										<button pButton label="Agregar"
											(click)="logGroupId(group.idgrouptaskcl); addActivity(group.idgrouptaskcl)"
											icon="pi pi-plus" ></button>
									</div>
								</div>
							</div>
						</td>
					</tr>
				</ng-template>
			</p-table>

			<!-- Modal para crear nuevo grupo -->
			<p-dialog header="Crear Nuevo Grupo" [(visible)]="displayModal" [modal]="true" [closable]="false">
				<div>
					<div class="p-field mb-3">
						<label for="groupName">Nombre del Grupo:</label>
						<input id="groupName" [(ngModel)]="newGroup.name" pInputText placeholder="Nombre del Grupo" />
					</div>
					<div class="p-field mb-3">
						<label for="startDate">Fecha de Inicio:</label>
						<input id="startDate" type="date" [(ngModel)]="newGroup.startdate" pInputText />
					</div>
					<div class="p-field mb-3">
						<label for="endDate">Fecha de Fin:</label>
						<input id="endDate" type="date" [(ngModel)]="newGroup.enddate" pInputText />
					</div>
				</div>
				<p-footer>
					<button pButton label="Cancelar" icon="pi pi-times" (click)="displayModal = false"></button>
					<button pButton label="Crear" icon="pi pi-check" (click)="createGroup()"></button>
				</p-footer>
			</p-dialog>
		</div>
	</div>
</div>